# eBPF Traffic Meter - Development Session Summary

**Date:** 2025-11-30  
**Project:** Per-user network traffic monitoring using eBPF

---

## Project Overview

Created an eBPF-based network traffic monitoring tool that captures per-user (UID) network traffic and logs it to CSV files. The tool tracks bytes transferred, source/destination IPs, direction (in/out), and cumulative totals.

---

## Key Technical Decisions

### 1. Hook Type Selection: cgroup_skb vs XDP

**Initial attempt:** XDP (eXpress Data Path)  
**Problem:** XDP operates at the driver level before socket association, so there's no UID context available.  
**Solution:** Switched to `cgroup_skb/egress` and `cgroup_skb/ingress` hooks which have access to socket information via `bpf_get_socket_uid()`.

### 2. Data Architecture: Hash Map vs Ring Buffer

**Initial approach:** BPF hash map accumulating bytes per UID  
**Problem:** Cumulative bytes made it impossible to distinguish sent vs received traffic per packet.  
**Solution:** Changed to ring buffer (`BPF_MAP_TYPE_RINGBUF`) streaming per-packet events with a direction field.

### 3. IPv6 Support Architecture

**Approach:** Separate ring buffers for IPv4 and IPv6 events due to different address sizes (4 bytes vs 16 bytes).  
**Multi-program attachment:** Used `BPF_F_ALLOW_MULTI` flag to attach multiple BPF programs to the same cgroup hook (IPv4 and IPv6 handlers on same egress/ingress hooks).

### 4. Cumulative Byte Tracking

**Location:** User-space (not kernel)  
**Implementation:** Hash table keyed by UID with O(1) lookup using chaining for collision resolution.  
**Scope:** Combined IPv4 + IPv6 totals per UID.

---

## File Structure

```
/home/ugo/tmp/ebpf/droid/
├── traffic_meter.bpf.c      # eBPF kernel-side program
├── traffic_meter_user.c     # User-space loader and event handler
├── Makefile                 # Build configuration
├── README.md                # Documentation
├── .gitignore               # Build artifact exclusions
└── ipv6-test.md             # IPv6 testing instructions
```

---

## Branches

### master (IPv4 only)
- Production-ready IPv4 traffic monitoring
- Single ring buffer for events
- Simpler codebase

### ipv6-support (IPv4 + IPv6)
- Dual ring buffer architecture
- Four BPF programs (egress/ingress × IPv4/IPv6)
- Uses `BPF_F_ALLOW_MULTI` for multi-program attachment
- `bpf_prog_detach2()` for precise program detachment

---

## Commit History

### master branch
```
5e29261 Add thorough comments to BPF and user-space code
dfdae1f Add .gitignore for build artifacts
282575f Add cumulative in/out byte totals to CSV output
647fb12 timestamp
03a9791 Add nanosecond-precision timestamp to CSV output
1563f25 IN/OUT
efe1a26 Add README documentation
c3d03ef Use ring buffer for per-packet events with direction field
fafcd2a Fix Makefile to build BPF object as part of all target
0d49848 Add NIC ID to per-user log filename
39545dc CSV
08dd5ef Appending instead of replacing
bc476b0 Created
```

### ipv6-support branch
```
c750d4d Add thorough comments to BPF and user-space code (IPv4+IPv6)
8221e61 Update README for IPv6 support and cumulative byte tracking
c9f0ab2 Merge master into ipv6-support
f6e5b23 ...
5e12542 ipv6
```

---

## CSV Output Format

```
direction,bytes,src_ip,dst_ip,timestamp,total_in,total_out
```

### Fields
| Field | Description |
|-------|-------------|
| direction | `in` (received) or `out` (sent) |
| bytes | Packet size in bytes |
| src_ip | Source IP address (IPv4 or IPv6) |
| dst_ip | Destination IP address (IPv4 or IPv6) |
| timestamp | Unix timestamp with nanosecond precision |
| total_in | Cumulative bytes received for this UID |
| total_out | Cumulative bytes sent for this UID |

### Example
```csv
out,52,192.168.1.100,8.8.8.8,1732985432.123456789,0,52
in,84,8.8.8.8,192.168.1.100,1732985432.234567890,84,52
out,80,2001:db8::1,2607:f8b0:4004:800::200e,1732985434.567890123,84,132
```

---

## Key Code Patterns

### BPF Ring Buffer Usage (Kernel Side)
```c
struct traffic_event *e = bpf_ringbuf_reserve(&events, sizeof(*e), 0);
if (!e)
    return 1;  /* Allow packet even if buffer full */

e->uid = bpf_get_socket_uid(skb);
e->bytes = skb->len;
/* ... populate other fields ... */

bpf_ringbuf_submit(e, 0);
```

### Ring Buffer Polling (User Side)
```c
struct ring_buffer *rb = ring_buffer__new(map_fd, handle_event, NULL, NULL);
while (!exiting) {
    ring_buffer__poll(rb, 100);  /* 100ms timeout */
}
```

### Multi-Ring Buffer (IPv6 Support)
```c
struct ring_buffer *rb = ring_buffer__new(ipv4_map_fd, handle_event, NULL, NULL);
ring_buffer__add(rb, ipv6_map_fd, handle_event_v6, NULL);
/* Single poll() handles both buffers */
```

### Per-UID Hash Table
```c
#define HASH_SIZE 1024
static struct uid_stats *uid_hash[HASH_SIZE];

static struct uid_stats *find_or_create_stats(__u32 uid) {
    unsigned int idx = uid % HASH_SIZE;
    struct uid_stats *s = uid_hash[idx];
    while (s) {
        if (s->uid == uid) return s;
        s = s->next;
    }
    s = calloc(1, sizeof(*s));
    s->uid = uid;
    s->next = uid_hash[idx];
    uid_hash[idx] = s;
    return s;
}
```

---

## Build & Run

### Dependencies (Fedora)
```bash
sudo dnf install clang libbpf-devel elfutils-libelf-devel zlib-devel
```

### Build
```bash
make clean && make
```

### Run
```bash
sudo ./traffic_meter_user [cgroup_path] [nic_id]

# Examples:
sudo ./traffic_meter_user "" eth0
sudo ./traffic_meter_user /sys/fs/cgroup/user.slice wlan0
```

### Output Location
```
/tmp/traffic_user_<nic_id>_<uid>.log
```

---

## Issues Encountered & Resolutions

| Issue | Resolution |
|-------|------------|
| No UID context in XDP | Switched to cgroup_skb hooks |
| Makefile missing BPF object in `all` target | Added `$(BPF_OBJ)` dependency |
| Bytes were cumulative across directions | Changed to per-packet events with direction field |
| Need to distinguish sent vs received | Added `total_in` and `total_out` cumulative fields |
| Merge conflicts (master → ipv6-support) | Manually integrated ring buffer architecture with IPv6 |

---

## Limitations

- Monitors cgroup-based traffic only (user processes), not raw interface traffic
- Requires cgroup v2
- Ring buffer can overflow under very high packet rates (events dropped, packets still pass)
- Log files grow indefinitely (no rotation)

---

## Future Enhancements

- Log rotation
- Protocol filtering (TCP/UDP/ICMP)
- Port number logging
- Configurable polling interval
- Configurable ring buffer size
- Binary output format for performance
